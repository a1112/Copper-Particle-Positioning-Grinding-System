铜粒子定位磨削系统软件开发文档
一、概述
本控制软件是针铜粒子铣床开发的上位机控制系统，具备高性能、高可靠性和良好的人机交互体验。系统采用模块化架构，集成了铜粒子路径规划、运动控制、报警管理、数据记录等核心功能，能够高效支持铜板粒子铣削任务。
二、系统架构与技术实现
1.总体结构
图 1.1 软件结构图
系统采用分层架构，主要包括：
硬件控制层：通过 TCP/IP协议与3D相机进行通讯，实现触发采集点云数据。
路径规划层：封装路径规划及气缸避让算法，实现一次采集，输出打磨路径坐标，加工数据匹配，气缸避让等多维数据包
业务逻辑层：封装各类报文解析、自动生成报文、运动模式、流程控制、报警检测及数据管理。
界面交互层：基于 winform技术实现可视化人机界面，提升操控便利性。
远程通讯层：通过基于 TCP 的自定义通讯协议，与机台应用系统实现高效交互。
远程通讯协议
本系统设计并实现了一套基于 TCP 协议的 高效定制通讯协议，用于上位机与机台控制系统之间的数据交换。
协议描述：
本标准的基础传输层构建在TCP/IP协议上，应用层的协议与具体的传输网络无关，应用层的具体协议详见下文。本标准与通讯介质无关。
应答模式
完整的命令由请求方发起、响应方应答组成，具体步骤如下：
请求方发送请求命令给响应方；
响应方接到请求后，向请求方发送请求应答（握手完成）；
请求方收到请求应答后，等待响应方回应执行结果；如果请求方未收到请求应答，按请求回应超时处理；
响应方执行请求操作；
响应方发送执行结果给请求方；
请求方收到执行结果，命令完成；如果请求方没有收到执行结果，按执行超时处理。
超时重发机制
一个请求命令发出后在规定的时间内未收到回应，视为超时：
超时后重发，重发超过规定次数后仍未收到回应视为通讯不可用，通讯结束；
超时时间根据具体的通讯方式和任务性质可自定义；
超时重发次数根据具体的通讯方式和任务性质可自定义。
请求方在收到请求回应后规定时间内未收到返回数据或命令执行结果，认为超时，命令执行失败，请求操作结束。
数据结构
图1 通讯协议数据结构
2.1 通讯包结构组成
表1 通讯包结构组成表
2.2 数据段结构组成
表2 数据段结构组成表
2.3 数据区
2.3.1 结构定义
字段与其值用’=’连接；在数据区中，同一项目的不同分类值用’，‘来分隔，不同项目之间用’；‘来分隔。
2.3.2 字段定义
2.3.2.1 字段名
字段名要区分大小写，单词的首个字符为大写，其他部分为小写。
2.3.2.2 数据类型
C4:        表示最多4位的字符型字符串，不足4位按实际位数；
N5:        表示最多5位的数字型字符串，不足5位按实际位数；
N14.2      用可变长字符串形式表达的数字型，表示14为整数和2位小数，带小数点，带符号，最大长度为18；
YYYY：     日期年，如2016表示2016年；
MM：      日期月，如09表示9月；
DD：       日期日，如24表示24日；
hh：       时间小时；
mm：      时间分钟；
ss：        时间秒；
zzz：       时间毫秒；
2.3.2.3 字段对照表
字段对照表如表3所示，表3中“宽度”仅包含该字段的内容长度。
表3 字段对照表
代码定义
3.1 执行结果定义
表4 执行结果定义表
3.2 请求命令返回
请求命令返回如表5所示。
表5 请求命令返回表
3.3 命令编码（可扩充）
对应“图4通讯协议数据结构”中的命令编码。
3.3.1 类别划分
共有四类命令（即请求命令、上传命令、通知命令和交互命令），命令编码分为以下四组：
100~199表示初始化命令和参数命令编码；
200~299表示数据命令编码；
300~399表示控制命令编码；
900~999表示交互命令编码。
3.3.2 命令编码方法
命令编码用3为阿拉伯数字表示，如表6所示。
表6 命令编码表
请求顺序
图2 请求顺序图
通讯命令示例和拆分包及应答机制示例
表7 设备初始化
表8设置机台工艺参数
表9 查询机台工艺参数
表10 添加执行动作
表11查询动作列表
表12执行动作
表8暂停动作
表9清除动作
表 10 追加DO 开
表 11 追加DO 关
表 12 DO开
表 13 DO关
表 14 查询设备DI状态列表
附 录 A
（规范性附录）
循环冗余校验（CRC）算法
CRC校验（Cyclic Redundancy Check）是一种数据传输错误检查方法。本标准采用ANSI CRC16， 简称CRC16。
CRC16 码由传输设备计算后加入到数据包中。接收设备重新计算接收数据包的CRC16码，并与接 收到的CRC16码比较，如果两值不同，则有误。
CRC16 校验字节的生成步骤如下：
1) CRC16 校验寄存器赋值为0xFFFF；
2) 取被校验串的第一个字节赋值给临时寄存器；
3) 临时寄存器与CRC16校验寄存器的高位字节进行“异或”运算，赋值给CRC16校验寄存器；
4) 取CRC16校验寄存器最后一位赋值给检测寄存器；
5) 把CRC16校验寄存器右移一位；
6) 若检测寄存器值为1，CRC16校验寄存器与多项式0xA001进行“异或”运算，赋值给CRC16 校验寄存器；
7) 重复步骤4~6，直至移出8位；
8) 取被校验串的下一个字节赋值给临时寄存器；
9) 重复步骤3~8，直至被校验串的所有字节均被校验；
10) 返回CRC16校验寄存器的值。 校验码按照先高字节后低字节的顺序存放。
CRC校验算法示例：
/****************************************************************************************
函 数: CRC16_Checkout
描 述: CRC16循环冗余校验算法。
参 数 一: *puchMsg：需要校验的字符串指针
参 数 二: usDataLen：要校验的字符串长度
返 回 值: 返回CRC16校验码
****************************************************************************************/
附 录 B
IO设备取值说明
使用5位16进制来对IO设备进行编址，每位16进制可以表示4个IO设备 4*5 即共可表示20个IO设备。
表1机台IO设备编址
允许同时操控多个DO设备，例如若需要打开气缸 1~12 可以使用 位运算 ‘|’对各个气缸IO的地址值进行连接运算。
查询DI列表时同理，指令可以仅仅查询关注的0~n|{n<20} 个DI信号，例如需要查询气缸 {2,6,8}
UI界面设计
图3 界面效果图
人机交互界面因具备如下基本功能：
因能显示3D相机实时画面，及触发后的路径规划图。
因能直观的显示机台当前状态，后台以轮训的形式获取机台状态，当机台异常时，应能采取相关连锁机制，禁止触发和远控的相关功能，确保安全。
如图所示：
应能统计打磨总数，打磨耗时，等相关统计数据，
需要显示当前配方；
需要输出日志及报警信息（包括但不限于监测机台异常状态及软件本身报警）；
需要具备离线调试功能；
需要具备通讯测试功能；
需要具备系统参数设置功能；
需要具备配方管理功能；
需要具备打磨数据统计功能，输出表格功能；
后台交互逻辑：